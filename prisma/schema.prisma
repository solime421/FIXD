generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              Int      @id @default(autoincrement())
  email           String   @unique
  firstName       String
  lastName        String
  phone           String?
  passwordHash    String
  role            Role
  profilePicture  String?
  locationAddress String?
  locationLat     Float?
  locationLng     Float?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  freelancerDetails FreelancerDetails? // 1 к 1 связь с профилем фрилансера

  ordersAsClient     Order[]  @relation("ClientOrders")
  ordersAsFreelancer Order[]  @relation("FreelancerOrders")
  chatsAsClient      Chat[]   @relation("ClientChats")
  chatsAsFreelancer  Chat[]   @relation("FreelancerChats")
  reviewsWritten     Review[] @relation("ReviewsWritten")
  reviewsReceived    Review[] @relation("ReviewsReceived")

  // Дополнительные связи с другими моделями
  offers   Offer[]   @relation("UserOffers")
  messages Message[] @relation("UserMessages")
}

enum Role {
  client
  freelancer
}

model FreelancerDetails {
  userId               Int      @id
  aboutMeSmall         String?
  aboutMeDetailed      String?
  countryOfOrigin      String?
  memberSince          DateTime @default(now())
  urgentServiceEnabled Boolean  @default(false)
  depositAmount        Float?

  // Связь с таблицей User
  user User @relation(fields: [userId], references: [id])

  portfolioImages PortfolioImage[] @relation("FreelancerPortfolio")
  specialties     Specialty[]      @relation("FreelancerSpecialties")
}

model PortfolioImage {
  id           Int      @id @default(autoincrement())
  freelancerId Int
  imageUrl     String
  createdAt    DateTime @default(now())

  freelancer FreelancerDetails @relation(fields: [freelancerId], references: [userId], name: "FreelancerPortfolio")
  // Ссылка на владельца портфолио
}

model Specialty {
  id           Int    @id @default(autoincrement())
  freelancerId Int
  specialty    String

  freelancer FreelancerDetails @relation(fields: [freelancerId], references: [userId], name: "FreelancerSpecialties")
}

model Order {
  id           Int      @id @default(autoincrement())
  clientId     Int
  freelancerId Int
  offerName    String // 'Снимок' названия принятого оффера
  status       Boolean  @default(false) // false = в процессе, true = завершен
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now())

  client     User @relation("ClientOrders", fields: [clientId], references: [id])
  freelancer User @relation("FreelancerOrders", fields: [freelancerId], references: [id])

  // Связь с отзывом (1 к 1)
  review Review?
}

model Offer {
  id           Int       @id @default(autoincrement())
  chatId       Int
  freelancerId Int
  offerName    String
  accepted     Boolean   @default(false)
  declined      Boolean  @default(false)
  createdAt    DateTime  @default(now())
  acceptedAt   DateTime?

  chat       Chat @relation(fields: [chatId], references: [id])
  freelancer User @relation(fields: [freelancerId], references: [id], name: "UserOffers")
  // Предложение привязано к чату и фрилансеру
}

model Chat {
  id           Int      @id @default(autoincrement())
  clientId     Int
  freelancerId Int
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now())

  client     User @relation("ClientChats", fields: [clientId], references: [id])
  freelancer User @relation("FreelancerChats", fields: [freelancerId], references: [id])

  // One-to-many
  messages Message[]
  offers   Offer[]
}

model Message {
  id        Int      @id @default(autoincrement())
  chatId    Int
  senderId  Int
  message   String
  createdAt DateTime @default(now())
  isRead    Boolean  @default(false) // New field to mark if the message is read

  // Relations…
  chat   Chat @relation(fields: [chatId], references: [id])
  sender User @relation(fields: [senderId], references: [id], name: "UserMessages")
}

model Review {
  id         Int      @id @default(autoincrement())
  orderId    Int      @unique
  reviewerId Int
  revieweeId Int
  rating     Int
  comment    String?
  createdAt  DateTime @default(now())

  order    Order @relation(fields: [orderId], references: [id])
  reviewer User  @relation("ReviewsWritten", fields: [reviewerId], references: [id])
  reviewee User  @relation("ReviewsReceived", fields: [revieweeId], references: [id])
}
